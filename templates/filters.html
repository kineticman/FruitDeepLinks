<!DOCTYPE html>
<html>
<head>
<title>Filters & Settings - FruitDeepLinks</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
color: #e2e8f0;
padding: 20px;
min-height: 100vh;
}
.container { max-width: 1400px; margin: 0 auto; }
h1 { font-size: 32px; margin-bottom: 10px; }
.subtitle { color: #94a3b8; margin-bottom: 30px; }
.nav-bar { margin-bottom: 20px; }

.nav {
margin-bottom: 30px;
display: flex;
gap: 15px;
}
.nav a {
color: #60a5fa;
text-decoration: none;
padding: 8px 16px;
border-radius: 6px;
background: #1e293b;
border: 1px solid #334155;
}
.nav a:hover { background: #334155; }
.card {
background: #1e293b;
border-radius: 12px;
padding: 24px;
margin-bottom: 20px;
border: 1px solid #334155;
}
h2 {
font-size: 20px;
margin-bottom: 16px;
display: flex;
align-items: center;
gap: 8px;
}
.section-description {
color: #94a3b8;
margin-bottom: 20px;
font-size: 14px;
}
.filter-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
gap: 12px;
}
.filter-item {
background: #0f172a;
border: 2px solid #334155;
border-radius: 8px;
padding: 12px;
cursor: pointer;
transition: all 0.2s;
display: flex;
align-items: center;
gap: 12px;
}
.filter-item:hover {
border-color: #3b82f6;
background: #1e293b;
}
.filter-item.enabled {
border-color: #22c55e;
background: #14532d;
}
.filter-item.disabled {
border-color: #ef4444;
background: #7f1d1d;
}
.checkbox {
width: 20px;
height: 20px;
border: 2px solid #475569;
border-radius: 4px;
display: flex;
align-items: center;
justify-content: center;
flex-shrink: 0;
}
.filter-item.enabled .checkbox {
background: #22c55e;
border-color: #22c55e;
}
.filter-item.disabled .checkbox {
background: #ef4444;
border-color: #ef4444;
}
.checkbox::after {
content: '‚úì';
color: white;
font-weight: bold;
display: none;
}
.filter-item.enabled .checkbox::after,
.filter-item.disabled .checkbox::after {
display: block;
}
.filter-item.disabled .checkbox::after {
content: '‚úó';
}
.filter-info {
flex: 1;
}
.filter-name {
font-weight: 600;
margin-bottom: 4px;
}
.filter-count {
font-size: 12px;
color: #94a3b8;
}
.btn {
background: #3b82f6;
color: white;
border: none;
padding: 12px 24px;
border-radius: 6px;
cursor: pointer;
font-size: 16px;
font-weight: 600;
margin-right: 10px;
}
.btn:hover { background: #2563eb; }
.btn:disabled { background: #475569; cursor: not-allowed; }
.btn-success { background: #22c55e; }
.btn-success:hover { background: #16a34a; }
.actions {
margin-top: 30px;
padding-top: 20px;
border-top: 1px solid #334155;
display: flex;
gap: 10px;
align-items: center;
}
.status-message {
margin-left: auto;
padding: 8px 16px;
border-radius: 6px;
font-size: 14px;
display: none;
}
.status-message.success {
background: #14532d;
color: #22c55e;
border: 1px solid #22c55e;
}
.status-message.error {
background: #7f1d1d;
color: #ef4444;
border: 1px solid #ef4444;
}
.loading {
text-align: center;
padding: 40px;
color: #94a3b8;
}
.stats-summary {
display: flex;
gap: 20px;
margin-bottom: 20px;
flex-wrap: wrap;
}
.stat-box {
background: #0f172a;
padding: 12px 20px;
border-radius: 8px;
border: 1px solid #334155;
}
.stat-label {
font-size: 12px;
color: #94a3b8;
margin-bottom: 4px;
}
.stat-value {
font-size: 24px;
font-weight: 600;
color: #60a5fa;
}
.priority-list {
display: flex;
flex-direction: column;
gap: 8px;
max-width: 600px;
}
.priority-item {
background: #0f172a;
border: 2px solid #334155;
border-radius: 8px;
padding: 12px 16px;
display: flex;
align-items: center;
gap: 12px;
cursor: grab;
transition: all 0.2s;
}
.priority-item:active {
cursor: grabbing;
}
.priority-item.sortable-ghost {
opacity: 0.4;
background: #1e293b;
}
.priority-item.sortable-drag {
opacity: 0.8;
box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}
.drag-handle {
font-size: 20px;
color: #64748b;
cursor: grab;
user-select: none;
}
.priority-number {
min-width: 40px;
text-align: center;
font-weight: 600;
color: #60a5fa;
font-size: 18px;
}
.priority-service-info {
flex: 1;
}
.priority-service-name {
font-weight: 600;
margin-bottom: 2px;
}
.priority-service-code {
font-size: 12px;
color: #94a3b8;
}
.amazon-penalty-option {
margin-top: 20px;
padding: 16px;
background: #0f172a;
border-radius: 8px;
border: 1px solid #334155;
}
.amazon-penalty-option label {
display: flex;
align-items: center;
gap: 12px;
cursor: pointer;
}
.amazon-penalty-option input[type="checkbox"] {
width: 20px;
height: 20px;
cursor: pointer;
}
.priority-help {
color: #94a3b8;
font-size: 14px;
margin-bottom: 16px;
padding: 12px;
background: #0f172a;
border-radius: 6px;
border-left: 3px solid #60a5fa;
}
.examples-grid {
display: grid;
gap: 12px;
}
.example-card {
background: #0f172a;
border: 1px solid #334155;
border-radius: 8px;
padding: 16px;
}
.example-title {
font-weight: 600;
margin-bottom: 8px;
color: #e2e8f0;
}
.example-services {
display: flex;
flex-wrap: wrap;
gap: 6px;
margin: 8px 0;
}
.example-service {
padding: 4px 10px;
border-radius: 4px;
font-size: 12px;
background: #1e293b;
border: 1px solid #334155;
}
.example-service.winner {
background: #14532d;
border-color: #22c55e;
color: #22c55e;
font-weight: 600;
}
.example-reason {
font-size: 13px;
color: #94a3b8;
margin-top: 8px;
font-style: italic;
}
</style>
</head>
<body>
<div class="container">
<h1>Filters & Settings</h1>
<p class="subtitle">Configure which services and content types to include in your channels</p>

<div class="nav">
<a href="/">Back to Dashboard</a>
</div>

<div class="stats-summary" id="stats-summary">
<div class="stat-box">
<div class="stat-label">Streaming Services</div>
<div class="stat-value" id="stat-providers">-</div>
</div>
<div class="stat-box">
<div class="stat-label">Sports Available</div>
<div class="stat-value" id="stat-sports">-</div>
</div>
<div class="stat-box">
<div class="stat-label">Leagues Available</div>
<div class="stat-value" id="stat-leagues">-</div>
</div>
</div>

<div class="card">
<h2>üì∫ Streaming Services</h2>
<p class="section-description">
Select which streaming services you have subscriptions to. Only events available on your selected services will be included in generated playlists.
<strong>Green = Enabled</strong> (will be included) | <strong>Red = Disabled</strong> (will be excluded)
</p>
<div id="providers-loading" class="loading">Loading services...</div>
<div id="providers-grid" class="filter-grid" style="display: none;"></div>
</div>

<div class="card" id="amazon-section">
<h2>üì¶ Amazon Services</h2>
<p class="section-description">
Amazon Prime Video hosts multiple streaming services. Enable the master toggle to use Amazon, then select which sub-services you want.
<strong>Note:</strong> "Amazon - Unknown" includes unscraped events and may contain false positives.
</p>

<!-- Master Toggle -->
<div style="margin-bottom: 20px;">
<div class="filter-item" id="amazon-master-toggle" onclick="toggleAmazonMaster()" 
     style="background: #1e293b; border: 3px solid #fbbf24; cursor: pointer; padding: 16px;">
<div class="checkbox"></div>
<div class="filter-info">
<div class="filter-name" style="font-size: 18px; font-weight: 700;">üîß Amazon (Master Toggle)</div>
<div class="filter-count" id="amazon-total-count">Loading...</div>
</div>
</div>
</div>

<!-- Sub-services -->
<div id="amazon-services-wrapper" style="opacity: 1; transition: opacity 0.3s;">
<div id="amazon-services-loading" class="loading">Loading Amazon services...</div>
<div id="amazon-services-grid" class="filter-grid" style="display: none;"></div>
</div>
</div>

<div class="card">
<h2>üåê Language Preference</h2>
<p class="section-description">
When events are available in multiple languages (e.g. ESPN and ESPN Deportes), choose your preferred language.
</p>
<div class="filter-grid">
<div class="filter-item enabled" onclick="setLanguage('en')" id="lang-en">
<div class="checkbox"></div>
<div class="filter-info">
<div class="filter-name">English</div>
<div class="filter-count">Prefer English broadcasts when available</div>
</div>
</div>
<div class="filter-item disabled" onclick="setLanguage('es')" id="lang-es">
<div class="checkbox"></div>
<div class="filter-info">
<div class="filter-name">Spanish (Espa√±ol)</div>
<div class="filter-count">Prefer Spanish broadcasts when available</div>
</div>
</div>
<div class="filter-item disabled" onclick="setLanguage('both')" id="lang-both">
<div class="checkbox"></div>
<div class="filter-info">
<div class="filter-name">Both / No Filter</div>
<div class="filter-count">Include all language variants</div>
</div>
</div>
</div>
</div>

<div class="card">
<h2>üéØ Service Priority Order</h2>
<div class="priority-help">
<strong>‚ö° When multiple services have the same event, which should be used?</strong><br>
Drag services to reorder them. Higher position = higher priority. Services at the top will be preferred over those below.
</div>

<div id="priority-loading" class="loading">Loading priorities...</div>
<div id="priority-list" class="priority-list" style="display: none;"></div>

<div class="amazon-penalty-option">
<label>
<input type="checkbox" id="amazon-penalty" checked>
<div>
<strong>Prefer direct streaming services over Amazon redirects</strong><br>
<span style="font-size: 13px; color: #94a3b8;">
Amazon Prime often redirects to other services (TNT, HBO Max, etc.). 
When enabled, we'll use the direct service link when available.
</span>
</div>
</label>
</div>
</div>

<div class="card">
<h2>üîç Selection Examples</h2>
<p class="section-description">
See which services will be selected for events with multiple options. This updates as you change priorities.
</p>
<div id="examples-loading" class="loading">Loading examples...</div>
<div id="examples-grid" class="examples-grid" style="display: none;"></div>
</div>

<div class="card">
<h2>‚öΩ Sports Filter</h2>
<p class="section-description">
Hide sports you're not interested in. Disabled sports will be excluded from your channels.
</p>
<div id="sports-loading" class="loading">Loading sports...</div>
<div id="sports-grid" class="filter-grid" style="display: none;"></div>
</div>

<div class="card">
<h2>üèÜ Leagues Filter</h2>
<p class="section-description">
Hide specific leagues or competitions. Disabled leagues will be excluded from your channels.
</p>
<div id="leagues-loading" class="loading">Loading leagues...</div>
<div id="leagues-grid" class="filter-grid" style="display: none;"></div>
</div>

<div class="actions">
<button class="btn btn-success" onclick="savePreferences()">Save Settings</button>
<button class="btn" style="background: #f59e0b;" onclick="applyFilters()">‚ö° Apply Filters Now</button>
<button class="btn" onclick="resetToDefaults()">Reset to Defaults</button>
<div class="status-message" id="status-message"></div>
</div>
</div>

<script>
let currentPreferences = {
enabled_services: [],
disabled_sports: [],
disabled_leagues: [],
service_priorities: {},
amazon_penalty: true,
amazon_master_enabled: true,
language_preference: 'en'  // 'en', 'es', or 'both'
};

let availableFilters = {
providers: [],
amazon_services: [],
sports: [],
leagues: []
};

let sortableInstance = null;

async function loadFilters() {
try {
const res = await fetch('/api/filters');
const data = await res.json();

availableFilters = data.filters;
currentPreferences = data.preferences;

// If no enabled services, default to ALL enabled (including Amazon)
if (!currentPreferences.enabled_services || currentPreferences.enabled_services.length === 0) {
currentPreferences.enabled_services = [
...availableFilters.providers.map(p => p.scheme),
...(availableFilters.amazon_services || []).map(s => s.scheme)
];
}

// Load priorities
await loadPriorities();

// Set default language preference if not present
if (!currentPreferences.language_preference) {
currentPreferences.language_preference = 'en';
}

// Set default amazon_master_enabled if not present
if (currentPreferences.amazon_master_enabled === undefined) {
currentPreferences.amazon_master_enabled = true;
}

renderProviders();
renderAmazonServices();
renderSports();
renderLeagues();
renderPriorities();
updateStats();

// Update language UI
setLanguage(currentPreferences.language_preference);

// Load selection examples
loadSelectionExamples();

} catch (err) {
console.error('Failed to load filters:', err);
showStatus('Failed to load filters', 'error');
}
}

async function loadPriorities() {
try {
const res = await fetch('/api/filters/priorities');
const data = await res.json();

currentPreferences.service_priorities = data.service_priorities || {};
currentPreferences.amazon_penalty = data.amazon_penalty !== undefined ? data.amazon_penalty : true;

document.getElementById('amazon-penalty').checked = currentPreferences.amazon_penalty;
} catch (err) {
console.error('Failed to load priorities:', err);
}
}

function renderPriorities() {
const container = document.getElementById('priority-list');
const loading = document.getElementById('priority-loading');

// Get only enabled services
const enabledServices = availableFilters.providers.filter(p => 
currentPreferences.enabled_services.includes(p.scheme)
);

if (enabledServices.length === 0) {
loading.textContent = 'No services enabled. Enable services above to set priorities.';
return;
}

// Sort by priority (highest first)
enabledServices.sort((a, b) => {
const priorityA = currentPreferences.service_priorities[a.scheme] || 50;
const priorityB = currentPreferences.service_priorities[b.scheme] || 50;
return priorityB - priorityA;
});

container.innerHTML = enabledServices.map((provider, index) => {
const priority = currentPreferences.service_priorities[provider.scheme] || 50;
return `
<div class="priority-item" data-service="${provider.scheme}" data-priority="${priority}">
<div class="drag-handle">‚ãÆ‚ãÆ</div>
<div class="priority-number">${priority}</div>
<div class="priority-service-info">
<div class="priority-service-name">${provider.name}</div>
<div class="priority-service-code">${provider.scheme} ‚Ä¢ ${provider.count} events</div>
</div>
</div>
`;
}).join('');

loading.style.display = 'none';
container.style.display = 'flex';

// Initialize Sortable.js
if (sortableInstance) {
sortableInstance.destroy();
}

sortableInstance = new Sortable(container, {
animation: 150,
handle: '.drag-handle',
ghostClass: 'sortable-ghost',
dragClass: 'sortable-drag',
onEnd: function(evt) {
updatePrioritiesFromOrder();
loadSelectionExamples(); // Refresh examples after reorder
}
});
}

function updatePrioritiesFromOrder() {
const items = document.querySelectorAll('.priority-item');
const totalItems = items.length;

// Recalculate priorities based on position
// Top item gets highest priority, bottom gets lowest
items.forEach((item, index) => {
const service = item.dataset.service;
// Distribute priorities evenly from 100 (top) to 10 (bottom)
const newPriority = Math.round(100 - (index / Math.max(1, totalItems - 1)) * 90);
currentPreferences.service_priorities[service] = newPriority;

// Update display
const priorityEl = item.querySelector('.priority-number');
if (priorityEl) {
priorityEl.textContent = newPriority;
}
item.dataset.priority = newPriority;
});
}

async function loadSelectionExamples() {
const examplesGrid = document.getElementById('examples-grid');
const loading = document.getElementById('examples-loading');

try {
const res = await fetch('/api/filters/selection-examples');
const data = await res.json();

if (!data.examples || data.examples.length === 0) {
loading.textContent = 'No multi-service events found to show examples.';
return;
}

examplesGrid.innerHTML = data.examples.map(example => {
const availableHtml = example.available_services.map(svc => {
const isWinner = example.selected_service && svc.code === example.selected_service.code;
return `<span class="example-service ${isWinner ? 'winner' : ''}">${svc.name}</span>`;
}).join('');

const winnerText = example.selected_service 
? `‚úÖ Selected: <strong>${example.selected_service.name}</strong>`
: '‚ùå No service selected';

return `
<div class="example-card">
<div class="example-title">${example.title}</div>
<div style="font-size: 12px; color: #64748b; margin-bottom: 8px;">
${example.channel} ‚Ä¢ ${new Date(example.start_utc).toLocaleString()}
</div>
<div class="example-services">${availableHtml}</div>
<div class="example-reason">
${winnerText}<br>
<span style="color: #64748b;">${example.reason}</span>
</div>
</div>
`;
}).join('');

loading.style.display = 'none';
examplesGrid.style.display = 'grid';

} catch (err) {
console.error('Failed to load examples:', err);
loading.textContent = 'Failed to load selection examples.';
}
}

// Update Amazon penalty when checkbox changes
document.addEventListener('DOMContentLoaded', function() {
const checkbox = document.getElementById('amazon-penalty');
if (checkbox) {
checkbox.addEventListener('change', function() {
currentPreferences.amazon_penalty = this.checked;
loadSelectionExamples(); // Refresh examples
});
}
});

function renderProviders() {
const grid = document.getElementById('providers-grid');
const loading = document.getElementById('providers-loading');

if (availableFilters.providers.length === 0) {
loading.textContent = 'No streaming services found. Run a refresh first.';
return;
}

grid.innerHTML = availableFilters.providers.map(provider => {
const isEnabled = currentPreferences.enabled_services.includes(provider.scheme);
return `
<div class="filter-item ${isEnabled ? 'enabled' : 'disabled'}" 
onclick="toggleProvider('${provider.scheme}')">
<div class="checkbox"></div>
<div class="filter-info">
<div class="filter-name">${provider.name}</div>
<div class="filter-count">${provider.count} events</div>
</div>
</div>
`;
}).join('');

loading.style.display = 'none';
grid.style.display = 'grid';
}

function renderAmazonServices() {
const grid = document.getElementById('amazon-services-grid');
const loading = document.getElementById('amazon-services-loading');
const masterToggle = document.getElementById('amazon-master-toggle');
const wrapper = document.getElementById('amazon-services-wrapper');
const totalCount = document.getElementById('amazon-total-count');

const amazonMasterEnabled = currentPreferences.amazon_master_enabled !== false;

// Update master toggle appearance
if (amazonMasterEnabled) {
masterToggle.classList.remove('disabled');
masterToggle.classList.add('enabled');
wrapper.style.opacity = '1';
wrapper.style.pointerEvents = 'auto';
} else {
masterToggle.classList.remove('enabled');
masterToggle.classList.add('disabled');
wrapper.style.opacity = '0.4';
wrapper.style.pointerEvents = 'none';
}

if (!availableFilters.amazon_services || availableFilters.amazon_services.length === 0) {
loading.textContent = 'No Amazon services found.';
totalCount.textContent = '0 events';
return;
}

// Calculate total events
const total = availableFilters.amazon_services.reduce((sum, s) => sum + s.count, 0);
totalCount.textContent = `${total} total events`;

grid.innerHTML = availableFilters.amazon_services.map(service => {
const isEnabled = currentPreferences.enabled_services.includes(service.scheme);
return `
<div class="filter-item ${isEnabled ? 'enabled' : 'disabled'}" 
onclick="toggleAmazonService('${service.scheme}')">
<div class="checkbox"></div>
<div class="filter-info">
<div class="filter-name">${service.name}</div>
<div class="filter-count">${service.count} events</div>
</div>
</div>
`;
}).join('');

loading.style.display = 'none';
grid.style.display = 'grid';
}

function toggleAmazonMaster() {
currentPreferences.amazon_master_enabled = !currentPreferences.amazon_master_enabled;
renderAmazonServices();
loadSelectionExamples();
}

function toggleAmazonService(scheme) {
// Only allow toggling if master is enabled
if (currentPreferences.amazon_master_enabled === false) {
return;
}

const index = currentPreferences.enabled_services.indexOf(scheme);
if (index > -1) {
currentPreferences.enabled_services.splice(index, 1);
} else {
currentPreferences.enabled_services.push(scheme);
}
renderAmazonServices();
renderPriorities();
loadSelectionExamples();
}

function renderSports() {
const grid = document.getElementById('sports-grid');
const loading = document.getElementById('sports-loading');

if (availableFilters.sports.length === 0) {
loading.textContent = 'No sports data found.';
return;
}

grid.innerHTML = availableFilters.sports.map(sport => {
const isDisabled = currentPreferences.disabled_sports.includes(sport.name);
return `
<div class="filter-item ${isDisabled ? 'disabled' : 'enabled'}" 
onclick="toggleSport(\`${sport.name}\`)">
<div class="checkbox"></div>
<div class="filter-info">
<div class="filter-name">${sport.name}</div>
<div class="filter-count">${sport.count} events</div>
</div>
</div>
`;
}).join('');

loading.style.display = 'none';
grid.style.display = 'grid';
}

function renderLeagues() {
const grid = document.getElementById('leagues-grid');
const loading = document.getElementById('leagues-loading');

if (availableFilters.leagues.length === 0) {
loading.textContent = 'No leagues data found.';
return;
}

grid.innerHTML = availableFilters.leagues.map(league => {
const isDisabled = currentPreferences.disabled_leagues.includes(league.name);
return `
<div class="filter-item ${isDisabled ? 'disabled' : 'enabled'}" 
onclick="toggleLeague(\`${league.name}\`)">
<div class="checkbox"></div>
<div class="filter-info">
<div class="filter-name">${league.name}</div>
<div class="filter-count">${league.count} events</div>
</div>
</div>
`;
}).join('');

loading.style.display = 'none';
grid.style.display = 'grid';
}

function setLanguage(lang) {
currentPreferences.language_preference = lang;
// Update UI
['lang-en', 'lang-es', 'lang-both'].forEach(id => {
const el = document.getElementById(id);
el.classList.remove('enabled');
el.classList.add('disabled');
});
document.getElementById(`lang-${lang}`).classList.remove('disabled');
document.getElementById(`lang-${lang}`).classList.add('enabled');
}

function toggleProvider(scheme) {
const index = currentPreferences.enabled_services.indexOf(scheme);
if (index > -1) {
currentPreferences.enabled_services.splice(index, 1);
} else {
currentPreferences.enabled_services.push(scheme);
}
renderProviders();
renderPriorities(); // Update priority list when services change
loadSelectionExamples(); // Refresh examples
}

function toggleSport(name) {
const index = currentPreferences.disabled_sports.indexOf(name);
if (index > -1) {
currentPreferences.disabled_sports.splice(index, 1);
} else {
currentPreferences.disabled_sports.push(name);
}
renderSports();
}

function toggleLeague(name) {
const index = currentPreferences.disabled_leagues.indexOf(name);
if (index > -1) {
currentPreferences.disabled_leagues.splice(index, 1);
} else {
currentPreferences.disabled_leagues.push(name);
}
renderLeagues();
}

async function savePreferences() {
try {
// Save filter preferences (services, sports, leagues)
const filtersRes = await fetch('/api/filters/preferences', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({
enabled_services: currentPreferences.enabled_services,
disabled_sports: currentPreferences.disabled_sports,
disabled_leagues: currentPreferences.disabled_leagues,
language_preference: currentPreferences.language_preference,
amazon_master_enabled: currentPreferences.amazon_master_enabled
})
});

// Save priorities and Amazon penalty
const prioritiesRes = await fetch('/api/filters/priorities', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({
service_priorities: currentPreferences.service_priorities,
amazon_penalty: currentPreferences.amazon_penalty
})
});

if (filtersRes.ok && prioritiesRes.ok) {
showStatus('Settings saved! Click Apply Filters Now to regenerate channels.', 'success');
} else {
showStatus('Failed to save settings', 'error');
}
} catch (err) {
console.error('Error saving settings', err);
showStatus('Error saving settings', 'error');
}
}

async function applyFilters() {
// Save first, then apply
try {
// Save filters
const saveFiltersRes = await fetch('/api/filters/preferences', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({
enabled_services: currentPreferences.enabled_services,
disabled_sports: currentPreferences.disabled_sports,
disabled_leagues: currentPreferences.disabled_leagues,
language_preference: currentPreferences.language_preference,
amazon_master_enabled: currentPreferences.amazon_master_enabled
})
});

// Save priorities
const savePrioritiesRes = await fetch('/api/filters/priorities', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({
service_priorities: currentPreferences.service_priorities,
amazon_penalty: currentPreferences.amazon_penalty
})
});

if (!saveFiltersRes.ok || !savePrioritiesRes.ok) {
showStatus('Failed to save settings', 'error');
return;
}

// Now apply filters
const applyRes = await fetch('/api/apply-filters', {
method: 'POST',
headers: {'Content-Type': 'application/json'}
});

if (applyRes.ok) {
showStatus('Applying filters... This takes ~10 seconds. Check dashboard for progress.', 'success');

// Redirect to dashboard after 2 seconds
setTimeout(() => {
window.location.href = '/';
}, 2000);
} else {
const data = await applyRes.json();
showStatus((data.error || 'Failed to apply filters'), 'error');
}
} catch (err) {
showStatus('Error applying filters', 'error');
}
}

function resetToDefaults() {
if (confirm('Reset all filters to defaults? This will enable all services and sports.')) {
currentPreferences = {
enabled_services: availableFilters.providers.map(p => p.scheme),
disabled_sports: [],
disabled_leagues: [],
service_priorities: {}, // Will use defaults from backend
amazon_penalty: true,
language_preference: 'en'
};
renderProviders();
renderSports();
renderLeagues();
renderPriorities();
loadSelectionExamples();
showStatus('Reset to defaults. Click Save to apply.', 'success');
}
}

function showStatus(message, type) {
const statusEl = document.getElementById('status-message');
statusEl.textContent = message;
statusEl.className = `status-message ${type}`;
statusEl.style.display = 'block';
setTimeout(() => {
statusEl.style.display = 'none';
}, 5000);
}

function updateStats() {
document.getElementById('stat-providers').textContent = availableFilters.providers.length;
document.getElementById('stat-sports').textContent = availableFilters.sports.length;
document.getElementById('stat-leagues').textContent = availableFilters.leagues.length;
}

// Initialize
loadFilters();
</script>
</body>
</html>
