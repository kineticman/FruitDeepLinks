<!DOCTYPE html>
<html>
<head>
<title>ADB Configuration - FruitDeepLinks</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
color: #e2e8f0;
padding: 20px;
min-height: 100vh;
}
.container { max-width: 1400px; margin: 0 auto; }
h1 { font-size: 32px; margin-bottom: 10px; }
.subtitle { color: #94a3b8; margin-bottom: 30px; }

.nav {
margin-bottom: 30px;
display: flex;
gap: 15px;
}
.nav a {
color: #60a5fa;
text-decoration: none;
padding: 8px 16px;
border-radius: 6px;
background: #1e293b;
border: 1px solid #334155;
}
.nav a:hover { background: #334155; }

.card {
background: #1e293b;
border-radius: 12px;
padding: 24px;
margin-bottom: 20px;
border: 1px solid #334155;
}
h2 {
font-size: 20px;
margin-bottom: 16px;
display: flex;
align-items: center;
gap: 8px;
}
.section-description {
color: #94a3b8;
margin-bottom: 20px;
font-size: 14px;
line-height: 1.6;
}

.provider-lanes-table {
width: 100%;
border-collapse: collapse;
margin-top: 10px;
font-size: 14px;
}
.provider-lanes-table th,
.provider-lanes-table td {
border-bottom: 1px solid #334155;
padding: 12px 8px;
text-align: left;
}
.provider-lanes-table th {
font-weight: 600;
color: #e2e8f0;
background: #0f172a;
}
.provider-lanes-table tr:hover {
background: #111827;
}
.provider-lanes-table input[type="number"] {
width: 90px;
padding: 6px 8px;
border-radius: 4px;
border: 1px solid #334155;
background: #020617;
color: #e2e8f0;
font-size: 14px;
}
.provider-lanes-table input[type="checkbox"] {
width: 18px;
height: 18px;
cursor: pointer;
}

.btn {
background: #3b82f6;
color: white;
border: none;
padding: 10px 20px;
border-radius: 6px;
cursor: pointer;
font-size: 14px;
margin-right: 10px;
}
.btn:hover { background: #2563eb; }
.btn:disabled { background: #475569; cursor: not-allowed; }
.btn-secondary { background: #64748b; }
.btn-secondary:hover { background: #475569; }
.btn-success { background: #22c55e; }
.btn-success:hover { background: #16a34a; }
.btn-danger { background: #ef4444; }
.btn-danger:hover { background: #dc2626; }

.loading { color: #fbbf24; }
.status-message {
padding: 12px;
border-radius: 6px;
margin-bottom: 20px;
display: none;
}
.status-success {
background: #14532d;
border: 1px solid #22c55e;
color: #22c55e;
}
.status-error {
background: #7f1d1d;
border: 1px solid #ef4444;
color: #ef4444;
}

code {
background: #0f172a;
padding: 2px 6px;
border-radius: 4px;
font-size: 13px;
color: #60a5fa;
}
</style>
</head>
<body>
<div class="container">
<h1>üîß ADB Configuration</h1>
<p class="subtitle">Configure provider lanes for ADBTuner and ChromeCapture integrations</p>

<div class="nav">
<a href="/">‚Üê Admin Dashboard</a>
<a href="/filters">Filters & Settings</a>
<a href="/api">API Helper</a>
</div>

<div id="status-message" class="status-message"></div>

<div class="card">
<h2>üì∫ Provider Lane Configuration</h2>
<div class="section-description">
<p style="margin-bottom: 12px;">
<strong>What is this?</strong> ADB lanes allow integration with ADBTuner and ChromeCapture for Channels DVR. 
Each enabled provider gets dedicated virtual channels that can be tuned via ADB commands.
</p>
<p style="margin-bottom: 12px;">
<strong>How it works:</strong>
</p>
<ul style="margin-left: 20px; margin-bottom: 12px;">
<li style="margin-bottom: 6px;">Enable providers you want to expose via ADB</li>
<li style="margin-bottom: 6px;">Set how many lanes each provider should get (based on concurrent events)</li>
<li style="margin-bottom: 6px;">Export generates M3U/XMLTV files for ADBTuner integration</li>
<li style="margin-bottom: 6px;">Changes here do NOT affect your normal Channels DVR view</li>
</ul>
<p style="color: #fbbf24;">
‚ö†Ô∏è <strong>Note:</strong> After saving changes, run "Apply Filters Now" from the Filters page or trigger a refresh to regenerate ADB lane files.
</p>
</div>

<div id="provider-lanes-loading" class="loading">Loading provider lanes...</div>
<div id="provider-lanes-empty" class="loading" style="display: none;">No providers found. Run a refresh first to populate data.</div>
<div id="provider-lanes-table-wrapper" style="display: none; overflow-x: auto;">
<table class="provider-lanes-table">
<thead>
<tr>
<th style="min-width: 140px;">Provider Code</th>
<th style="min-width: 200px;">Provider Name</th>
<th style="min-width: 120px; text-align: right;">Events Available</th>
<th style="min-width: 120px; text-align: center;">ADB Enabled</th>
<th style="min-width: 140px;">Lane Count</th>
<th style="min-width: 110px; text-align: center;">Actions</th>
</tr>
</thead>
<tbody id="provider-lanes-tbody"></tbody>
</table>
</div>

<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #334155;">
<button class="btn btn-success" onclick="saveProviderLanes()" id="btn-save-lanes">üíæ Save ADB Configuration</button>
<button class="btn btn-secondary" onclick="loadProviderLanes()">üîÑ Reload</button>
</div>
</div>

<div class="card">
<h2>üìã Integration Files</h2>
<div class="section-description">
After configuring and saving your ADB lanes, each enabled provider generates its own set of files for ADBTuner or ChromeCapture integration:
</div>

<div id="integration-files-loading" class="loading">Loading available files...</div>
<div id="integration-files-list" style="display: none;">
<!-- Will be populated dynamically -->
</div>

<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #334155;">
<p style="color: #94a3b8; font-size: 13px;">
<strong>Note:</strong> Files are generated when you run "Apply Filters" or trigger a refresh after saving your ADB configuration.
</p>
</div>
</div>

<div class="card">
<h2>‚ÑπÔ∏è Quick Guide</h2>
<div class="section-description">
<p style="margin-bottom: 12px;"><strong>Example Configuration:</strong></p>
<ul style="margin-left: 20px; line-height: 1.8;">
<li><code>ESPN+</code>: Enable, 5 lanes ‚Üí Creates channels for ESPN+ events 1-5</li>
<li><code>Peacock</code>: Enable, 3 lanes ‚Üí Creates channels for Peacock events 1-3</li>
<li><code>Paramount+</code>: Disable ‚Üí No ADB channels created</li>
</ul>
<p style="margin-top: 16px; margin-bottom: 12px;"><strong>Recommended Lane Counts:</strong></p>
<ul style="margin-left: 20px; line-height: 1.8;">
<li>Small providers (1-10 events): 1-2 lanes</li>
<li>Medium providers (10-50 events): 3-5 lanes</li>
<li>Large providers (50+ events): 5-10 lanes</li>
</ul>
</div>
</div>
</div>

<script>
let providerLanes = [];

function showStatus(message, type = 'success') {
const statusEl = document.getElementById('status-message');
statusEl.textContent = message;
statusEl.className = `status-message status-${type}`;
statusEl.style.display = 'block';
setTimeout(() => {
statusEl.style.display = 'none';
}, 5000);
}

async function deleteProviderLane(providerCode) {
try {
const code = (providerCode || '').trim();
if (!code) return;

if (!confirm(`Delete provider "${code}" from ADB provider lane config?\n\nThis removes the saved config row. If the provider appears again in future playables, it can re-appear automatically.`)) {
return;
}

const res = await fetch(`/api/provider_lanes/${encodeURIComponent(code)}`, { method: 'DELETE' });
if (!res.ok) {
const data = await res.json().catch(() => ({}));
throw new Error(data.error || `HTTP ${res.status}`);
}

showStatus(`üóëÔ∏è Deleted provider "${code}"`, 'success');
await loadProviderLanes();
await loadIntegrationFiles();

} catch (err) {
console.error('Failed to delete provider lane:', err);
showStatus('Error deleting provider: ' + err.message, 'error');
}
}

async function loadProviderLanes() {

try {
const loading = document.getElementById('provider-lanes-loading');
const empty = document.getElementById('provider-lanes-empty');
const wrapper = document.getElementById('provider-lanes-table-wrapper');
const tbody = document.getElementById('provider-lanes-tbody');

loading.style.display = 'block';
empty.style.display = 'none';
wrapper.style.display = 'none';

// Fetch provider lanes config (now includes event counts!)
const lanesRes = await fetch('/api/provider_lanes');

if (!lanesRes.ok) throw new Error('Failed to load provider lanes');

const lanesData = await lanesRes.json();

loading.style.display = 'none';

if (!lanesData.providers || lanesData.providers.length === 0) {
empty.style.display = 'block';
wrapper.style.display = 'none';
return;
}

providerLanes = lanesData.providers;

wrapper.style.display = 'block';

tbody.innerHTML = providerLanes.map(p => {
// Format event counts with future events in parentheses
const eventCount = p.event_count || 0;
const futureCount = p.future_event_count || 0;
const eventDisplay = futureCount < eventCount 
? `${eventCount} <span style="color: #94a3b8; font-size: 11px;">(${futureCount} upcoming)</span>`
: `${eventCount}`;

return `
<tr>
<td><code>${p.provider_code}</code></td>
<td>${p.name || p.provider_code}</td>
<td style="text-align: right;">${eventDisplay}</td>
<td style="text-align: center;">
<input type="checkbox" 
data-provider="${p.provider_code}" 
class="adb-enabled-checkbox"
${p.adb_enabled ? 'checked' : ''}>
</td>
<td>
<input type="number" 
min="0" max="50" 
data-provider="${p.provider_code}"
class="adb-lane-count-input"
value="${p.adb_lane_count || 0}">

</td>
<td style="text-align: center;">
${(() => {
const ec = p.event_count || 0;
const fc = p.future_event_count || 0;
const pc = p.playable_count || 0;
const enabled = !!p.adb_enabled;
const isStale = (ec === 0 && fc === 0 && pc === 0);
// Only allow delete for fully-stale rows AND not enabled (avoid surprises)
if (!isStale || enabled) return '<span style="color: #64748b; font-size: 12px;">‚Äî</span>';
return `<button class="btn btn-danger" onclick="deleteProviderLane('${p.provider_code}')">Delete</button>`;
})()}
</td>
</tr>
`;
}).join('');

} catch (err) {
console.error('Failed to load provider lanes:', err);
showStatus('Error loading provider lanes: ' + err.message, 'error');
document.getElementById('provider-lanes-loading').textContent = 'Error loading provider lanes';
}
}

async function saveProviderLanes() {
try {
const updates = [];
const checkboxes = document.querySelectorAll('.adb-enabled-checkbox');
const inputs = document.querySelectorAll('.adb-lane-count-input');

checkboxes.forEach(cb => {
const code = cb.dataset.provider;
const enabled = cb.checked;
const countInput = Array.from(inputs).find(i => i.dataset.provider === code);
const count = countInput ? parseInt(countInput.value) || 0 : 0;

updates.push({
provider_code: code,
adb_enabled: enabled,
adb_lane_count: count
});
});

const btnSave = document.getElementById('btn-save-lanes');
btnSave.disabled = true;
btnSave.textContent = 'üíæ Saving...';

const res = await fetch('/api/provider_lanes', {
method: 'POST',
headers: {'Content-Type': 'application/json'},
body: JSON.stringify({providers: updates})
});

btnSave.disabled = false;
btnSave.textContent = 'üíæ Save ADB Configuration';

if (!res.ok) {
const data = await res.json().catch(() => ({}));
throw new Error(data.error || 'Failed to save');
}

showStatus('‚úÖ ADB configuration saved successfully! Run "Apply Filters" or trigger a refresh to regenerate files.', 'success');
loadProviderLanes();
loadIntegrationFiles();

} catch (err) {
showStatus('‚ùå Error saving ADB configuration: ' + err.message, 'error');
}
}

async function loadIntegrationFiles() {
try {
const loading = document.getElementById('integration-files-loading');
const listEl = document.getElementById('integration-files-list');

loading.style.display = 'block';
listEl.style.display = 'none';

const res = await fetch('/api/status');
if (!res.ok) throw new Error('Failed to load files');
const data = await res.json();

loading.style.display = 'none';

if (!data.files || Object.keys(data.files).length === 0) {
listEl.innerHTML = '<p style="color: #94a3b8; font-style: italic;">No files generated yet. Save your ADB configuration and run "Apply Filters".</p>';
listEl.style.display = 'block';
return;
}

// Filter for ADB-related files
const adbFiles = Object.entries(data.files).filter(([name]) => 
name.includes('adb_lanes') || name.includes('_lanes.m3u') || name.includes('_lanes.xml')
);

if (adbFiles.length === 0) {
listEl.innerHTML = '<p style="color: #94a3b8; font-style: italic;">No ADB files found. Generate them by running "Apply Filters" after saving your configuration.</p>';
listEl.style.display = 'block';
return;
}

// Group files by provider
const fileGroups = {};
const globalFiles = [];

adbFiles.forEach(([name, info]) => {
if (name === 'adb_lanes.m3u' || name === 'adb_lanes.xml' || name === 'adb_lanes_chrome.m3u') {
globalFiles.push([name, info]);
} else {
// Extract provider from filename (e.g., "espn_lanes.m3u" -> "espn")
const match = name.match(/^(.+?)_lanes/);
if (match) {
const provider = match[1];
if (!fileGroups[provider]) {
fileGroups[provider] = [];
}
fileGroups[provider].push([name, info]);
}
}
});

let html = '';

// Global/combined files first
if (globalFiles.length > 0) {
html += '<div style="margin-bottom: 20px;"><h3 style="font-size: 16px; margin-bottom: 12px; color: #fbbf24;">üì¶ Combined (All Providers)</h3><ul style="list-style: none; padding: 0;">';
globalFiles.forEach(([name, info]) => {
const sizeMB = (info.size / 1024 / 1024).toFixed(2);
html += `
<li style="padding: 10px; background: #0f172a; border-radius: 6px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center;">
<a href="/out/${name}" style="color: #60a5fa; text-decoration: none; font-family: monospace; font-size: 13px;">${name}</a>
<span style="color: #94a3b8; font-size: 12px;">${sizeMB} MB</span>
</li>
`;
});
html += '</ul></div>';
}

// Provider-specific files
const providers = Object.keys(fileGroups).sort();
if (providers.length > 0) {
providers.forEach(provider => {
const files = fileGroups[provider];
html += `<div style="margin-bottom: 16px;"><h3 style="font-size: 15px; margin-bottom: 8px; color: #60a5fa;">üì∫ ${provider.toUpperCase()}</h3><ul style="list-style: none; padding: 0;">`;
files.forEach(([name, info]) => {
const sizeMB = (info.size / 1024 / 1024).toFixed(2);
html += `
<li style="padding: 8px; background: #0f172a; border-radius: 6px; margin-bottom: 4px; display: flex; justify-content: space-between; align-items: center;">
<a href="/out/${name}" style="color: #60a5fa; text-decoration: none; font-family: monospace; font-size: 12px;">${name}</a>
<span style="color: #94a3b8; font-size: 11px;">${sizeMB} MB</span>
</li>
`;
});
html += '</ul></div>';
});
}

listEl.innerHTML = html;
listEl.style.display = 'block';

} catch (err) {
console.error('Failed to load integration files:', err);
document.getElementById('integration-files-loading').textContent = 'Error loading files';
}
}

// Initialize
loadProviderLanes();
loadIntegrationFiles();
</script>
</body>
</html>
